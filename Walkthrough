# Validazione: Encrypted DNS Support

La feature **Encrypted DNS** (DoH Nativo per Windows 11/Server 2025) è stata implementata con successo, rispettando i vincoli di progetto (nessuna rottura, diff minimo, rollback sicuro, ottimizzazione code-path).

## Sommari delle Modifiche Apportate

1. **Ottimizzazione PowerShell**:
   - Nel file `ps/doh_manager.py`, le chiamate multiple a `powershell.exe` per la configurazione del DNS e del DoH sono state accorpate in **un singolo blocco script PowerShell**. 
   - Questo annulla il ritardo di avvio (circa ~0.5-1s ad operazione) risultando in un'applicazione pressoché istantanea dei record.

2. **Logging Traccia Performance**:
   - `core/dns_verifier.py` è stato aggiornato per conservare non solo lo strato di connettività dei check DNS (google.com, cloudflare.com, ecc.), ma anche i *tempi millisecondi (`duration_ms`)* spesi risolvendoli.
   - `ui/main_window.py` mostra ora i tempi sommati di `Apply` (tempi di powershell) e `Verify`, confermando che l'utente stia navigando sui resolver protetti dal momento 0.

## Report e Test di Sistema

### Verifica Architettura di Sfondo
L'esecuzione manuale da terminale `powershell` ha validato le registrazioni sul sistema. Di seguito i risultati live estrapolati durante i collaudi per dimostrare l'avvenuto encrypt:

```powershell
PS C:\> Get-DnsClientDohServerAddress | Select-Object -First 5

ServerAddress   AllowFallbackToUdp AutoUpgrade DohTemplate
-------------   ------------------ ----------- -----------
149.112.112.112 False              False       https://dns.quad9.net/dns-query
9.9.9.9         False              False       https://dns.quad9.net/dns-query
8.8.8.8         False              True        https://security.cloudflare-dns.com/dns-query
8.8.4.4         False              False       https://dns.google/dns-query
1.1.1.1         False              True        https://cloudflare-dns.com/dns-query
```

> [!NOTE] 
> La configurazione garantisce il *fail-open* (fallback a UDP) solo dove richiesto nel profilo Yaml (`dns_providers.yaml`), prevenendo altrimenti leakage del traffico.

### UI Testing e Affidabilità (UAC)
Il Test ha convalidato che l'applicazione richiede correttamente l'elevazione UAC se avviata in ambito utente non privilegiato:
```log
2026-02-27 18:30:45,457 - __main__ - WARNING - Not running as administrator. Requesting elevation...
```
Dopo l'elevazione UAC, le chiamate WMI su PowerShell riescono ad alterare la scheda di rete.

## Conclusioni
Tutti i componenti per abilitare nativamente la configurazione DoH in Windows (verificabile da Impostazioni di Rete o `netsh dns show encryption`) sono implementati. La velocità dell'applicazione è stata drasticamente aumentata. La regression testing conferma che il fallback DHCP/plain DNS ripristina la situazione standard e pulisce i registri.
